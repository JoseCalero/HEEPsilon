/*
                              *******************
******************************* C SOURCE FILE *******************************
**                            *******************                          **
**                                                                         **
** project  : HEEPsilon                                                  **
** filename : mmul.c                                                 **
** version  : 1                                                            **
** date     : 2023-10-25                                                       **
**                                                                         **
*****************************************************************************
**                                                                         **
** Copyright (c) EPFL                                                      **
** All rights reserved.                                                    **
**                                                                         **
*****************************************************************************
*/

/***************************************************************************/
/***************************************************************************/

/**
* @file   mmul.c
* @date   2023-10-25
* @brief  A description of the kernel...
*
*/

#define _MMUL_C

/****************************************************************************/
/**                                                                        **/
/*                             MODULES USED                                 */
/**                                                                        **/
/****************************************************************************/
#include <stdint.h>

#include "mmul.h"
#include "function.h"

/****************************************************************************/
/**                                                                        **/
/*                        DEFINITIONS AND MACROS                            */
/**                                                                        **/
/****************************************************************************/


/****************************************************************************/
/**                                                                        **/
/*                      PROTOTYPES OF LOCAL FUNCTIONS                       */
/**                                                                        **/
/****************************************************************************/

static void        config  (void);
static void        software(void);
static uint32_t    check   (void);

/****************************************************************************/
/**                                                                        **/
/*                            GLOBAL VARIABLES                              */
/**                                                                        **/
/****************************************************************************/

// Bitstream mmul v3
//const uint32_t  cgra_imem_mmul[CGRA_IMEM_SIZE] = { 0xa90000, 0x30b0000, 0x30d0000, 0x30f0000, 0xa80000, 0x0, 0x0, 0x16180000, 0x1090000, 0xa80000, 0x0, 0x0, 0x17180000, 0x61090000, 0xa80000, 0x0, 0x0, 0x18180000, 0x61090000, 0xa80000, 0x0, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0xc80000, 0xc80000, 0xab0000, 0x30d0000, 0x30f0000, 0x3090000, 0xa80000, 0x0, 0x0, 0x16180000, 0x1090000, 0xa80000, 0x0, 0x0, 0x17180000, 0x61090000, 0xa80000, 0x0, 0x0, 0x18180000, 0x61090000, 0xa80000, 0x0, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xad0000, 0x30f0000, 0x3090000, 0x30b0000, 0xa80000, 0x0, 0x0, 0x16180000, 0x1090000, 0xa80000, 0x0, 0x0, 0x17180000, 0x61090000, 0xa80000, 0x0, 0x0, 0x18180000, 0x61090000, 0xa80000, 0x0, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xaf0000, 0x3090000, 0x30b0000, 0x30d0000, 0xa80000, 0x0, 0x0, 0x16180000, 0x1090000, 0xa80000, 0x0, 0x0, 0x17180000, 0x61090000, 0xa80000, 0x0, 0x0, 0x18180000, 0x61090000, 0xa80000, 0x0, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xa90000, 0x30b0000, 0x30d0000, 0x30f0000, 0x0, 0x4080000, 0x0, 0x16180000, 0x1090000, 0x0, 0x4080000, 0x0, 0x17180000, 0x61090000, 0x0, 0x4080000, 0x0, 0x18180000, 0x61090000, 0x0, 0x4080000, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xab0000, 0x30d0000, 0x30f0000, 0x3090000, 0x0, 0x4080000, 0x0, 0x16180000, 0x1090000, 0x0, 0x4080000, 0x0, 0x17180000, 0x61090000, 0x0, 0x4080000, 0x0, 0x18180000, 0x61090000, 0x0, 0x4080000, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xad0000, 0x30f0000, 0x3090000, 0x30b0000, 0x0, 0x4080000, 0x0, 0x16180000, 0x1090000, 0x0, 0x4080000, 0x0, 0x17180000, 0x61090000, 0x0, 0x4080000, 0x0, 0x18180000, 0x61090000, 0x0, 0x4080000, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xaf0000, 0x3090000, 0x30b0000, 0x30d0000, 0x0, 0x4080000, 0x0, 0x16180000, 0x1090000, 0x0, 0x4080000, 0x0, 0x17180000, 0x61090000, 0x0, 0x4080000, 0x0, 0x18180000, 0x61090000, 0x0, 0x4080000, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xa90000, 0x30b0000, 0x30d0000, 0x30f0000, 0x0, 0x0, 0x4080000, 0x16180000, 0x1090000, 0x0, 0x0, 0x4080000, 0x17180000, 0x61090000, 0x0, 0x0, 0x4080000, 0x18180000, 0x61090000, 0x0, 0x0, 0x4080000, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xab0000, 0x30d0000, 0x30f0000, 0x3090000, 0x0, 0x0, 0x4080000, 0x16180000, 0x1090000, 0x0, 0x0, 0x4080000, 0x17180000, 0x61090000, 0x0, 0x0, 0x4080000, 0x18180000, 0x61090000, 0x0, 0x0, 0x4080000, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xad0000, 0x30f0000, 0x3090000, 0x30b0000, 0x0, 0x0, 0x4080000, 0x16180000, 0x1090000, 0x0, 0x0, 0x4080000, 0x17180000, 0x61090000, 0x0, 0x0, 0x4080000, 0x18180000, 0x61090000, 0x0, 0x0, 0x4080000, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xaf0000, 0x3090000, 0x30b0000, 0x30d0000, 0x0, 0x0, 0x4080000, 0x16180000, 0x1090000, 0x0, 0x0, 0x4080000, 0x17180000, 0x61090000, 0x0, 0x0, 0x4080000, 0x18180000, 0x61090000, 0x0, 0x0, 0x4080000, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xa90000, 0x30b0000, 0x30d0000, 0x30f0000, 0x0, 0x5080000, 0x0, 0x16180000, 0x1090000, 0x0, 0x5080000, 0x0, 0x17180000, 0x61090000, 0x0, 0x5080000, 0x0, 0x18180000, 0x61090000, 0x0, 0x5080000, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xab0000, 0x30d0000, 0x30f0000, 0x3090000, 0x0, 0x5080000, 0x0, 0x16180000, 0x1090000, 0x0, 0x5080000, 0x0, 0x17180000, 0x61090000, 0x0, 0x5080000, 0x0, 0x18180000, 0x61090000, 0x0, 0x5080000, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xad0000, 0x30f0000, 0x3090000, 0x30b0000, 0x0, 0x5080000, 0x0, 0x16180000, 0x1090000, 0x0, 0x5080000, 0x0, 0x17180000, 0x61090000, 0x0, 0x5080000, 0x0, 0x18180000, 0x61090000, 0x0, 0x5080000, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0xaf0000, 0x3090000, 0x30b0000, 0x30d0000, 0x0, 0x5080000, 0x0, 0x16180000, 0x1090000, 0x0, 0x5080000, 0x0, 0x17180000, 0x61090000, 0x0, 0x5080000, 0x0, 0x18180000, 0x61090000, 0x0, 0x5080000, 0x0, 0x19180000, 0x61090000, 0x10b00000, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 };
//static uint32_t cgra_kmem_mmul[CGRA_KMEM_SIZE] = { 0x0, 0xf01a, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 };

const uint32_t  cgra_imem_mmul[CGRA_IMEM_SIZE] = { 0x0, 0xf006, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0};
static uint32_t cgra_kmem_mmul[CGRA_KMEM_SIZE] = { 0x0, 0x0, 0x0, 0x0, 0x66800002, 0x0, 0xc80000, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xa90000, 0xab0000, 0x67800005, 0x6a090001, 0x90000, 0x0, 0x0, 0xab0000, 0xad0000, 0x0, 0x0, 0x0, 0x0, 0x0, 0xad0000, 0xaf0000, 0x0, 0x0, 0x0, 0xc80000, 0x0, 0xaf0000, 0xa90000, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc80000, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, };

static int32_t cgra_input[CGRA_N_COLS][ROWS_A+ROWS_B]    __attribute__ ((aligned (4)));
static int32_t cgra_output[CGRA_N_COLS][ROWS_A*COLS_B]   __attribute__ ((aligned (4)));

static int16_t outSW[ROWS_A*COLS_B];
static int16_t outCGRA[ROWS_A*COLS_B];

    static uint32_t	i_index_soft;
    static uint32_t	i_index_cgra;
    static uint32_t	i_NumBits_soft;
    static uint32_t	i_NumBits_cgra;
    static uint32_t	o_ret_soft;
    static uint32_t	o_ret_cgra;


/****************************************************************************/
/**                                                                        **/
/*                           EXPORTED VARIABLES                             */
/**                                                                        **/
/****************************************************************************/

extern kcom_kernel_t mmul_kernel = {
    .kmem   = cgra_kmem_mmul,
    .imem   = cgra_imem_mmul,
    .col_n  = CGRA_N_COLS,
    .in_n   = ROWS_A+ROWS_B,
    .out_n  = ROWS_A*COLS_B,
    .input  = cgra_input,
    .output = cgra_output,
    .config = config,
    .func   = software,
    .check  = check,
    .name   = "mmul",
};

/****************************************************************************/
/**                                                                        **/
/*                            LOCAL FUNCTIONS                               */
/**                                                                        **/
/****************************************************************************/


//static int16_t MatrixA[ROWS_A*COLS_A] = { 1,2,3, 4,5,6, 7,8,9};
//static int16_t MatrixB[ROWS_B*COLS_B] = { 10,10,10, 20,20,20, 30,30,30};


void config()
{
    // Matrix A 
    /* {1,2,3,4,
        5,6,7,8,
        9,10,11,12,
        13,14,15,16}
    */
    int cont = 0;
    for (int i=0; i < ROWS_A; i++,cont++){
        for(int j=0; j < COLS_A; j++){
            cgra_input[j][cont] = matrixA[i*COLS_A+j];
        }
    }
    //cgra_input[0][0] = 1; /*a00*/   cgra_input[1][0] = 2; /*a01*/   cgra_input[2][0] = 3; /*a02*/   cgra_input[3][0] = 4; /*a03*/
    //cgra_input[0][1] = 5; /*a10*/   cgra_input[1][1] = 6;           cgra_input[2][1] = 7;           cgra_input[3][1] = 8;
    //cgra_input[0][2] = 9; /*a20*/   cgra_input[1][2] = 10;          cgra_input[2][2] = 11;          cgra_input[3][2] = 12;
    //cgra_input[0][3] = 13;/*a30*/   cgra_input[1][3] = 14;          cgra_input[2][3] = 15;          cgra_input[3][3] = 16;
    
    // Matrix B 
    /* {1,2,3,4,
        5,6,7,8,
        9,10,11,12,
        13,14,15,16}
    */
    /* For v2
    for (int i=0; i < ROWS_B; i++,cont++){
    	int desp = 0;
        for(int j=0; j < COLS_B; j++,desp++){
            cgra_input[j][cont] = matrixB[((i+desp)%COLS_B)*COLS_B+j];
        }
    }*/
    
    //cgra_input[0][4] = 1;  /*b00*/    cgra_input[1][4] = 6;  /*b11*/      cgra_input[2][4] = 11; /*b22*/      cgra_input[3][4] = 16; /*b33*/
    //cgra_input[0][5] = 5;  /*b10*/    cgra_input[1][5] = 10; /*b21*/      cgra_input[2][5] = 15; /*b32*/      cgra_input[3][5] = 4; 
    //cgra_input[0][6] = 9;  /*b20*/    cgra_input[1][6] = 14; /*b31*/      cgra_input[2][6] = 3;  /*b02*/      cgra_input[3][6] = 8;
    //cgra_input[0][7] = 13; /*b30*/    cgra_input[1][7] = 2;  /*b01*/      cgra_input[2][7] = 7;  /*b12*/      cgra_input[3][7] = 12;  
    
    // For v3
    for (int i=0; i < ROWS_B; i++,cont++){
        for(int j=0; j < COLS_B; j++){
            cgra_input[j][cont] = matrixB[i*COLS_B+j];
        }
    }
    
}

void software(void)
{
    mmul( outSW );
}

uint32_t check(void)
{
    uint32_t errors = 0;
    //This gives the result matrix transposed because the result is grabbed by columns
    /*
    int cont = 0;
    for(int16_t i = 0; i < CGRA_N_COLS; i++) {
        for(int16_t j=0; j< CGRA_N_COLS; j++, cont++){
            outCGRA[cont] = cgra_output[i][j];
            PRINTF("cgra[%d,%d]=%d\n", i, j, cgra_output[i][j]);
        }
    }
    */
    
    int cont = 0;
    for(int16_t i = 0; i < CGRA_N_COLS; i++) {
        for(int16_t j=0; j< CGRA_N_COLS; j++, cont++){
            outCGRA[cont] = cgra_output[j][i];
        }
    }

    for( uint16_t i = 0; i < ROWS_A*COLS_B; i++ ){
        
        if(outSW[i]!=outCGRA[i]){
            errors++;
            PRINTF("[%d] %d != %d\n", i, outSW[i],outCGRA[i] );
        }
    }

    o_ret_cgra = outCGRA[4]; // ??

    return errors;
}

/****************************************************************************/
/**                                                                        **/
/**                                EOF                                     **/
/**                                                                        **/
/****************************************************************************/