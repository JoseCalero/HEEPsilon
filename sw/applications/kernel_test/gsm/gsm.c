/*
                              *******************
******************************* C SOURCE FILE *******************************
**                            *******************                          **
**                                                                         **
** project  : CGRA-X-HEEP                                                  **
** filename : gsm.c                                                 **
** version  : 1                                                            **
** date     : Today                                                       **
**                                                                         **
*****************************************************************************
**                                                                         **
** Copyright (c) EPFL                                                      **
** All rights reserved.                                                    **
**                                                                         **
*****************************************************************************
*/

/***************************************************************************/
/***************************************************************************/

/**
* @file   gsm.c
* @date   Today
* @brief  A description
*
*/

#define _GSM_C

/****************************************************************************/
/**                                                                        **/
/*                             MODULES USED                                 */
/**                                                                        **/
/****************************************************************************/
#include <stdint.h>

#include "gsm.h"
#include "cgra.h"
#include "data/function.h"

/****************************************************************************/
/**                                                                        **/
/*                        DEFINITIONS AND MACROS                            */
/**                                                                        **/
/****************************************************************************/

#define CGRA_COLS       4
#define IN_VAR_DEPTH    40
#define OUT_VAR_DEPTH   1

/****************************************************************************/
/**                                                                        **/
/*                      PROTOTYPES OF LOCAL FUNCTIONS                       */
/**                                                                        **/
/****************************************************************************/

static void        config  (void);
static void        software(void);
static uint32_t    check   (void);

/****************************************************************************/
/**                                                                        **/
/*                            GLOBAL VARIABLES                              */
/**                                                                        **/
/****************************************************************************/

static uint32_t cgra_kmem_bitstream[CGRA_KMEM_SIZE] = {	0x0,	0xf013,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0};
static uint32_t cgra_imem_bitstream[CGRA_IMEM_SIZE] = {	0x1a080000,	0x0,	0x4a080001,	0x0,	0x0,	0x0,	0x4a080001,	0x0,	0x0,	0x0,	0x4a080001,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0xc80000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x4100000,	0x0,	0x0,	0x0,	0x4100000,	0x0,	0x0,	0x0,	0x4100000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0xad0000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x82786000,	0x0,	0x0,	0x0,	0x82786000,	0x0,	0x0,	0x0,	0x82786000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0xa0f0028,	0x0,	0x0,	0x0,	0x4980000d,	0x0,	0x0,	0x0,	0x4980000d,	0x0,	0x0,	0x0,	0x49880009,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x2080000,	0x0,	0x0,	0x0,	0x2080000,	0x0,	0x0,	0x0,	0x2080000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x1a080000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x35100000,	0x53700000,	0x0,	0x0,	0x35100000,	0x53700000,	0x0,	0x0,	0x35100000,	0x53700000,	0x10b00000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x5080000,	0x0,	0x0,	0x0,	0x5080000,	0x0,	0x0,	0x0,	0x5080000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0xa90000,	0x0,	0x2a180004,	0x61080000,	0x0,	0x0,	0x2a180004,	0x61080000,	0x0,	0x0,	0x2a180004,	0x61080000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x1a080000,	0x0,	0x0,	0x0,	0x2b80000,	0x0,	0x0,	0x0,	0x2b80000,	0x0,	0x0,	0x0,	0x2b80000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0xa90000,	0x0,	0x0,	0x0,	0x0,	0x62100000,	0x2080000,	0x52700000,	0x0,	0x62100000,	0x2080000,	0x52700000,	0x0,	0x62100000,	0x2080000,	0x52700000,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0,	0x0};

static int32_t cgra_input[CGRA_COLS][IN_VAR_DEPTH]     __attribute__ ((aligned (4)));
static int32_t cgra_output[CGRA_COLS][OUT_VAR_DEPTH]   __attribute__ ((aligned (4)));
static int32_t sw_res, cgra_res;

static int32_t	x	[40];

static int32_t	ret	[1];
static int32_t	ret_sw	[1];


/****************************************************************************/
/**                                                                        **/
/*                           EXPORTED VARIABLES                             */
/**                                                                        **/
/****************************************************************************/

extern kcom_kernel_t gsm_kernel = {
    .kmem   = cgra_kmem_bitstream,
    .imem   = cgra_imem_bitstream,
    .col_n  = CGRA_COLS,
    .input  = cgra_input,
    .output = cgra_output,
    .config = config,
    .func   = software,
    .check  = check,
    .name   = "Gsm",
};

/****************************************************************************/
/**                                                                        **/
/*                            LOCAL FUNCTIONS                               */
/**                                                                        **/
/****************************************************************************/

static void config()
{
	for(int i = 0; i < 40; i++ )
		x[i] = kcom_getRand() % (32767 - -32768 + 1) + -32768;
	cgra_input[1][0] = x;
	cgra_input[3][0] = 32767;
	cgra_input[3][1] = -32768;

}

static void software(void) 
{
    sw_res = gsm( x );
}

static uint32_t check(void) 
{
    uint32_t errors = 0;
    cgra_res = cgra_output[3][0];  
    PRINTF("In : %04x > %d %d %d %d \n",cgra_output[3], cgra_output[3][0], cgra_output[3][1], cgra_output[3][2], cgra_output[3][3]);
    PRINTF("0 IS %04x\n", cgra_output[0]);
    PRINTF("Res: %d vs %d \n",sw_res, cgra_res);

    if (cgra_res != sw_res) {
        errors++;
    }
    return errors;
}

/****************************************************************************/
/**                                                                        **/
/**                                EOF                                     **/
/**                                                                        **/
/****************************************************************************/